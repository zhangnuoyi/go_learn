# NFT 拍卖市场 - 需求细化文档

## 1. 项目概述

本项目旨在开发一个基于 Ethereum 区块链的 NFT 拍卖市场，允许用户创建、参与和管理 NFT 拍卖。系统将支持多种支付方式（ETH 和 ERC20 代币），并通过 Chainlink 预言机实现价格转换，确保公平透明的拍卖环境。

## 2. 功能需求

### 2.1 NFT 管理功能

#### 2.1.1 NFT 铸造
- **功能描述**：允许授权用户铸造新的 NFT
- **触发方式**：调用 `mint` 函数
- **参数**：
  - `to`：接收 NFT 的地址
  - `uri`：NFT 的元数据 URI
- **返回值**：铸造的 NFT ID
- **权限**：仅合约所有者或授权地址
- **事件**：`Transfer(address indexed from, address indexed to, uint256 indexed tokenId)`

#### 2.1.2 NFT 查询
- **功能描述**：查询 NFT 的所有者、URI 等信息
- **触发方式**：调用相关视图函数
- **相关函数**：
  - `ownerOf(uint256 tokenId)`：查询 NFT 所有者
  - `tokenURI(uint256 tokenId)`：查询 NFT 元数据 URI
  - `balanceOf(address owner)`：查询地址拥有的 NFT 数量

### 2.2 拍卖管理功能

#### 2.2.1 拍卖创建
- **功能描述**：允许用户将 NFT 上架拍卖
- **触发方式**：调用 `createAuction` 函数
- **参数**：
  - `nftContract`：NFT 合约地址
  - `tokenId`：NFT ID
  - `reservePrice`：保留价
  - `duration`：拍卖持续时间（秒）
  - `paymentToken`：支付代币地址（ETH 用 0x0 表示）
- **返回值**：创建的拍卖 ID
- **前置条件**：
  - 用户拥有指定 NFT
  - 已授权合约转移 NFT
  - 保留价大于 0
  - 持续时间大于 0
- **操作**：
  - 转移 NFT 至合约托管
  - 初始化拍卖状态
- **事件**：`AuctionCreated(uint256 indexed auctionId, address indexed seller, address indexed nftContract, uint256 tokenId)`

#### 2.2.2 拍卖出价
- **功能描述**：允许用户对拍卖进行出价
- **触发方式**：调用 `placeBid` 函数
- **参数**：
  - `auctionId`：拍卖 ID
- **返回值**：无
- **前置条件**：
  - 拍卖未结束
  - 出价金额大于当前最高出价
  - 出价金额大于保留价
- **操作**：
  - 如果使用 ETH 出价，直接接收 ETH
  - 如果使用 ERC20 出价，从用户账户转移代币
  - 退还之前最高出价者的资金
  - 更新最高出价和出价者信息
- **事件**：`BidPlaced(uint256 indexed auctionId, address indexed bidder, uint256 amount)`

#### 2.2.3 拍卖结束
- **功能描述**：结束拍卖并结算
- **触发方式**：调用 `endAuction` 函数
- **参数**：
  - `auctionId`：拍卖 ID
- **返回值**：无
- **前置条件**：
  - 拍卖未结束
  - 拍卖已过结束时间
- **操作**：
  - 将 NFT 转移给最高出价者（如果有）
  - 将资金转移给卖家
  - 如果没有出价，将 NFT 退还卖家
  - 更新拍卖状态为已结束
- **事件**：`AuctionEnded(uint256 indexed auctionId, address indexed winner, uint256 amount)`

#### 2.2.4 拍卖查询
- **功能描述**：查询拍卖的详细信息
- **触发方式**：调用相关视图函数
- **相关函数**：
  - `getAuction(uint256 auctionId)`：查询指定拍卖信息
  - `getAuctions(uint256 offset, uint256 limit)`：查询拍卖列表

### 2.3 价格预言机功能

#### 2.3.1 价格获取
- **功能描述**：从 Chainlink 预言机获取代币价格
- **触发方式**：内部调用或外部查询
- **相关函数**：
  - `getLatestPrice(address aggregator)`：获取指定 aggregator 的最新价格
  - `getPriceFeed(address token)`：获取指定代币的价格 feed 地址

#### 2.3.2 价格转换
- **功能描述**：将代币金额转换为 USD
- **触发方式**：调用 `convertToUSD` 函数
- **参数**：
  - `amount`：代币金额
  - `token`：代币地址
- **返回值**：转换后的 USD 金额

#### 2.3.3 出价比较
- **功能描述**：比较不同代币的出价（转换为 USD 后）
- **触发方式**：内部调用 `compareBids` 函数
- **参数**：
  - `bid1`：第一个出价金额
  - `token1`：第一个出价代币
  - `bid2`：第二个出价金额
  - `token2`：第二个出价代币
- **返回值**：bid1 是否大于 bid2

### 2.4 合约升级功能

#### 2.4.1 合约升级
- **功能描述**：升级合约实现
- **触发方式**：调用 `upgradeTo` 或 `upgradeToAndCall` 函数
- **参数**：
  - `newImplementation`：新实现合约地址
- **权限**：仅合约所有者
- **事件**：`Upgraded(address indexed implementation)`

## 3. 数据结构

### 3.1 NFT 合约数据结构

| 数据结构 | 类型 | 用途 |
|----------|------|------|
| `_tokenOwner` | `mapping(uint256 => address)` | 记录每个 tokenId 的所有者 |
| `_tokenApprovals` | `mapping(uint256 => address)` | 记录每个 tokenId 的授权地址 |
| `_operatorApprovals` | `mapping(address => mapping(address => bool))` | 记录操作员授权 |
| `_tokenURIs` | `mapping(uint256 => string)` | 记录每个 tokenId 的 URI |
| `_tokenIds` | `uint256` | 记录当前 tokenId 计数器 |

### 3.2 拍卖合约数据结构

#### 3.2.1 Auction 结构体

```solidity
struct Auction {
    uint256 id;                    // 拍卖 ID
    address seller;                // 卖家地址
    address nftContract;           // NFT 合约地址
    uint256 tokenId;               // NFT ID
    uint256 startTime;             // 开始时间戳
    uint256 endTime;               // 结束时间戳
    uint256 reservePrice;          // 保留价
    address highestBidder;         // 当前最高出价者
    uint256 highestBid;            // 当前最高出价
    address paymentToken;          // 支付代币地址
    bool ended;                    // 是否已结束
}
```

#### 3.2.2 其他数据结构

| 数据结构 | 类型 | 用途 |
|----------|------|------|
| `_auctions` | `mapping(uint256 => Auction)` | 记录所有拍卖 |
| `_auctionCounter` | `uint256` | 拍卖 ID 计数器 |
| `_priceFeeds` | `mapping(address => address)` | 记录代币对应的价格 feed 地址 |
| `_pendingReturns` | `mapping(address => uint256)` | 记录待退还的资金 |

## 4. API 设计

### 4.1 NFT 合约 API

| 函数名 | 类型 | 可见性 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|--------|------|
| `constructor()` | 构造函数 | `public` | 无 | 无 | 初始化合约 |
| `mint(address to, string memory uri)` | 函数 | `public` | `to`: 接收地址<br>`uri`: NFT URI | `uint256` | 铸造新 NFT |
| `ownerOf(uint256 tokenId)` | 函数 | `public view` | `tokenId`: NFT ID | `address` | 查询 NFT 所有者 |
| `tokenURI(uint256 tokenId)` | 函数 | `public view` | `tokenId`: NFT ID | `string` | 查询 NFT URI |
| `balanceOf(address owner)` | 函数 | `public view` | `owner`: 地址 | `uint256` | 查询地址拥有的 NFT 数量 |
| `approve(address to, uint256 tokenId)` | 函数 | `public` | `to`: 授权地址<br>`tokenId`: NFT ID | 无 | 授权地址转移 NFT |
| `setApprovalForAll(address operator, bool approved)` | 函数 | `public` | `operator`: 操作员地址<br>`approved`: 是否授权 | 无 | 授权操作员管理所有 NFT |
| `transferFrom(address from, address to, uint256 tokenId)` | 函数 | `public` | `from`: 发送地址<br>`to`: 接收地址<br>`tokenId`: NFT ID | 无 | 转移 NFT |
| `safeTransferFrom(address from, address to, uint256 tokenId)` | 函数 | `public` | `from`: 发送地址<br>`to`: 接收地址<br>`tokenId`: NFT ID | 无 | 安全转移 NFT |
| `safeTransferFrom(address from, address to, uint256 tokenId, bytes memory data)` | 函数 | `public` | `from`: 发送地址<br>`to`: 接收地址<br>`tokenId`: NFT ID<br>`data`: 附加数据 | 无 | 带数据的安全转移 NFT |
| `getApproved(uint256 tokenId)` | 函数 | `public view` | `tokenId`: NFT ID | `address` | 查询 NFT 的授权地址 |
| `isApprovedForAll(address owner, address operator)` | 函数 | `public view` | `owner`: 所有者地址<br>`operator`: 操作员地址 | `bool` | 查询操作员是否被授权 |
| `supportsInterface(bytes4 interfaceId)` | 函数 | `public view` | `interfaceId`: 接口 ID | `bool` | 查询是否支持指定接口 |
| `upgradeTo(address newImplementation)` | 函数 | `external` | `newImplementation`: 新实现地址 | 无 | 升级合约实现 |
| `upgradeToAndCall(address newImplementation, bytes memory data)` | 函数 | `external payable` | `newImplementation`: 新实现地址<br>`data`: 调用数据 | 无 | 升级并调用新实现 |

### 4.2 拍卖合约 API

| 函数名 | 类型 | 可见性 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|--------|------|
| `constructor()` | 构造函数 | `public` | 无 | 无 | 初始化合约 |
| `createAuction(address nftContract, uint256 tokenId, uint256 reservePrice, uint256 duration, address paymentToken)` | 函数 | `public` | `nftContract`: NFT 合约地址<br>`tokenId`: NFT ID<br>`reservePrice`: 保留价<br>`duration`: 持续时间<br>`paymentToken`: 支付代币地址 | `uint256` | 创建新拍卖 |
| `placeBid(uint256 auctionId)` | 函数 | `public payable` | `auctionId`: 拍卖 ID | 无 | 对拍卖出价 |
| `endAuction(uint256 auctionId)` | 函数 | `public` | `auctionId`: 拍卖 ID | 无 | 结束拍卖并结算 |
| `withdraw()` | 函数 | `public` | 无 | `uint256` | 提取待退还的资金 |
| `getAuction(uint256 auctionId)` | 函数 | `public view` | `auctionId`: 拍卖 ID | `Auction` | 查询指定拍卖信息 |
| `getAuctions(uint256 offset, uint256 limit)` | 函数 | `public view` | `offset`: 偏移量<br>`limit`: 数量限制 | `Auction[]` | 查询拍卖列表 |
| `getLatestPrice(address aggregator)` | 函数 | `internal view` | `aggregator`: 价格 feed 地址 | `int` | 获取最新价格 |
| `convertToUSD(uint256 amount, address token)` | 函数 | `public view` | `amount`: 代币数量<br>`token`: 代币地址 | `uint256` | 转换为 USD 金额 |
| `compareBids(uint256 bid1, address token1, uint256 bid2, address token2)` | 函数 | `internal view` | `bid1`: 出价1<br>`token1`: 代币1<br>`bid2`: 出价2<br>`token2`: 代币2 | `bool` | 比较两个出价 |
| `setPriceFeed(address token, address aggregator)` | 函数 | `public` | `token`: 代币地址<br>`aggregator`: 价格 feed 地址 | 无 | 设置代币的价格 feed |
| `upgradeTo(address newImplementation)` | 函数 | `external` | `newImplementation`: 新实现地址 | 无 | 升级合约实现 |
| `upgradeToAndCall(address newImplementation, bytes memory data)` | 函数 | `external payable` | `newImplementation`: 新实现地址<br>`data`: 调用数据 | 无 | 升级并调用新实现 |

## 5. 事件设计

### 5.1 NFT 合约事件

| 事件名 | 参数 | 描述 |
|--------|------|------|
| `Transfer` | `address indexed from, address indexed to, uint256 indexed tokenId` | NFT 转移事件 |
| `Approval` | `address indexed owner, address indexed approved, uint256 indexed tokenId` | NFT 授权事件 |
| `ApprovalForAll` | `address indexed owner, address indexed operator, bool approved` | 操作员授权事件 |
| `Upgraded` | `address indexed implementation` | 合约升级事件 |

### 5.2 拍卖合约事件

| 事件名 | 参数 | 描述 |
|--------|------|------|
| `AuctionCreated` | `uint256 indexed auctionId, address indexed seller, address indexed nftContract, uint256 tokenId` | 拍卖创建事件 |
| `BidPlaced` | `uint256 indexed auctionId, address indexed bidder, uint256 amount` | 出价事件 |
| `AuctionEnded` | `uint256 indexed auctionId, address indexed winner, uint256 amount` | 拍卖结束事件 |
| `PriceFeedSet` | `address indexed token, address indexed aggregator` | 价格 feed 设置事件 |
| `Upgraded` | `address indexed implementation` | 合约升级事件 |

## 6. 安全设计

### 6.1 重入攻击防护
- **实现方式**：使用 Checks-Effects-Interactions 模式
- **具体措施**：
  - 先更新状态变量，再进行外部调用
  - 使用 `ReentrancyGuard` 修饰符

### 6.2 访问控制
- **实现方式**：使用 `Ownable` 修饰符
- **具体措施**：
  - 关键函数仅允许合约所有者调用
  - 升级功能严格控制访问权限

### 6.3 输入验证
- **实现方式**：在函数开始处验证参数
- **具体验证**：
  - 地址有效性验证
  - 数值范围验证
  - 状态验证

### 6.4 预言机安全
- **实现方式**：使用 Chainlink 预言机，并添加安全机制
- **具体措施**：
  - 验证价格更新时间
  - 实现价格偏差检查
  - 支持手动更新价格 feed 地址

### 6.5 资金安全
- **实现方式**：使用安全的资金处理机制
- **具体措施**：
  - 使用 `SafeERC20` 处理 ERC20 代币转移
  - 实现 `withdraw` 函数让用户提取资金
  - 避免资金锁定

## 7. 升级设计

### 7.1 UUPS 代理模式
- **实现方式**：使用 OpenZeppelin 的 `UUPSUpgradeable` 合约
- **优势**：
  - 升级成本低（仅需调用一次）
  - 实现合约可重用
  - 支持复杂的升级逻辑

### 7.2 升级流程
1. 开发新的实现合约
2. 部署新的实现合约
3. 调用 `upgradeTo` 或 `upgradeToAndCall` 函数升级
4. 验证升级后的功能

### 7.3 升级权限
- 仅合约所有者可执行升级操作
- 建议使用多签钱包管理合约所有权
- 考虑添加时间锁机制

## 8. 测试用例

### 8.1 NFT 合约测试

#### 8.1.1 铸造测试
- 测试普通铸造功能
- 测试批量铸造功能
- 测试权限控制

#### 8.1.2 转移测试
- 测试正常转移
- 测试授权转移
- 测试操作员转移
- 测试无效转移（如无权限）

#### 8.1.3 查询测试
- 测试 `ownerOf` 函数
- 测试 `tokenURI` 函数
- 测试 `balanceOf` 函数

### 8.2 拍卖合约测试

#### 8.2.1 创建拍卖测试
- 测试正常创建拍卖
- 测试创建拍卖权限
- 测试无效参数（如零保留价）

#### 8.2.2 出价测试
- 测试 ETH 出价
- 测试 ERC20 出价
- 测试无效出价（如低于当前最高价）
- 测试拍卖结束后出价

#### 8.2.3 结束拍卖测试
- 测试正常结束拍卖
- 测试拍卖结束前调用
- 测试无出价时结束拍卖

#### 8.2.4 退款测试
- 测试出价被超越后的退款
- 测试 `withdraw` 函数

### 8.3 预言机集成测试

#### 8.3.1 价格获取测试
- 测试获取 ETH/USD 价格
- 测试获取 ERC20/USD 价格
- 测试无效价格 feed 地址

#### 8.3.2 价格转换测试
- 测试 ETH 转换为 USD
- 测试 ERC20 转换为 USD
- 测试不同金额的转换

#### 8.3.3 出价比较测试
- 测试相同代币出价比较
- 测试不同代币出价比较

### 8.4 合约升级测试

#### 8.4.1 升级功能测试
- 测试正常升级流程
- 测试升级后功能完整性
- 测试升级后状态保留

#### 8.4.2 升级权限测试
- 测试非所有者升级
- 测试升级参数验证

## 9. 部署配置

### 9.1 环境变量

| 变量名 | 用途 | 示例值 |
|--------|------|--------|
| `SEPOLIA_URL` | Sepolia 测试网 RPC URL | `https://sepolia.infura.io/v3/YOUR_INFURA_KEY` |
| `PRIVATE_KEY` | 部署账户私钥 | `0xYOUR_PRIVATE_KEY` |
| `ETHERSCAN_API_KEY` | Etherscan API Key | `YOUR_ETHERSCAN_KEY` |
| `CHAINLINK_ETH_USD_FEED` | ETH/USD 价格 feed 地址 | `0x694AA1769357215DE4FAC081bf1f309aDC325306` |
| `CHAINLINK_USDC_USD_FEED` | USDC/USD 价格 feed 地址 | `0xA2F78ab2355fe2f984D808B5CeE7FD0A93D5270E` |

### 9.2 部署脚本

#### 9.2.1 NFT 合约部署脚本（01_deploy_nft.js）

```javascript
module.exports = async ({ getNamedAccounts, deployments }) => {
  const { deploy } = deployments;
  const { deployer } = await getNamedAccounts();

  await deploy('AuctionNFT', {
    from: deployer,
    args: [],
    log: true,
    proxy: {
      proxyContract: 'UUPSProxy',
      execute: {
        init: {
          methodName: 'initialize',
          args: [],
        },
      },
    },
  });
};
module.exports.tags = ['AuctionNFT'];
```

#### 9.2.2 拍卖合约部署脚本（02_deploy_marketplace.js）

```javascript
module.exports = async ({ getNamedAccounts, deployments }) => {
  const { deploy, get } = deployments;
  const { deployer } = await getNamedAccounts();
  const auctionNFT = await get('AuctionNFT');

  await deploy('NFTMarketplace', {
    from: deployer,
    args: [],
    log: true,
    proxy: {
      proxyContract: 'UUPSProxy',
      execute: {
        init: {
          methodName: 'initialize',
          args: [],
        },
      },
    },
  });
};
module.exports.tags = ['NFTMarketplace'];
module.exports.dependencies = ['AuctionNFT'];
```

## 10. 监控与维护

### 10.1 事件监控
- 监控关键事件：`AuctionCreated`、`BidPlaced`、`AuctionEnded`
- 实现事件通知机制

### 10.2 性能监控
- 监控合约调用 gas 消耗
- 优化高消耗函数

### 10.3 安全监控
- 监控异常交易
- 定期审计合约代码
- 关注依赖库安全更新

## 11. 扩展功能

### 11.1 动态手续费
- 根据拍卖金额动态调整手续费率
- 实现手续费分配机制

### 11.2 拍卖撤销
- 允许卖家在特定条件下撤销拍卖
- 实现撤销条件验证

### 11.3 批量操作
- 支持批量创建拍卖
- 支持批量查询拍卖

### 11.4 拍卖历史记录
- 实现拍卖历史记录查询
- 支持按条件筛选

### 11.5 前端界面
- 实现用户友好的前端界面
- 支持拍卖创建、出价、查询等功能

## 12. 交付标准

### 12.1 代码质量
- 代码符合 Solidity 最佳实践
- 完整的注释文档
- 通过所有测试用例
- 测试覆盖率达到 90% 以上

### 12.2 文档完整性
- 架构设计文档
- 需求细化文档
- 合约 API 文档
- 部署指南
- 测试报告

### 12.3 安全要求
- 无已知安全漏洞
- 通过基础安全审计
- 实现所有安全设计要求

### 12.4 功能完整性
- 实现所有核心功能
- 支持所有指定支付方式
- 实现合约升级机制

---

## 附录：价格 Feed 地址

### Sepolia 测试网

| 代币 | 地址 |
|------|------|
| ETH/USD | 0x694AA1769357215DE4FAC081bf1f309aDC325306 |
| USDC/USD | 0xA2F78ab2355fe2f984D808B5CeE7FD0A93D5270E |
| LINK/USD | 0xc59E3633BAAC79493d908e63626716e204A45EdF |
| DAI/USD | 0x14866185B1962B63C3Ea9E03Bc1da838bab34C19 |

### Mainnet

| 代币 | 地址 |
|------|------|
| ETH/USD | 0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419 |
| USDC/USD | 0x8fFfFfd4AfB6115b954Bd326cbe7B4BA576818f6 |
| LINK/USD | 0x2c1d072e956AFFC0D435Cb7AC38EF18d24d9127c |
| DAI/USD | 0xAed0c38402a5d19df6E4c03F4E2DceD6e29c1ee9 |