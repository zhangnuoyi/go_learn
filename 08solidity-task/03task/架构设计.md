# NFT 拍卖市场 - 架构设计文档

## 1. 项目概述

本项目旨在开发一个基于 Ethereum 区块链的 NFT 拍卖市场，允许用户创建、参与和管理 NFT 拍卖。系统将支持多种支付方式（ETH 和 ERC20 代币），并通过 Chainlink 预言机实现价格转换，确保公平透明的拍卖环境。

### 1.1 核心功能

- NFT 铸造与管理
- 拍卖创建与管理
- 多币种出价（ETH/ERC20）
- 价格转换与比较（通过 Chainlink 预言机）
- 合约升级机制（UUPS 代理模式）

## 2. 技术栈

| 类别 | 技术/框架 | 版本 | 用途 |
|------|-----------|------|------|
| 开发框架 | Hardhat | ^2.19.0 | 智能合约开发、测试与部署 |
| 合约库 | OpenZeppelin Contracts | ^4.9.0 | ERC721 实现、代理升级模式 |
| 预言机 | Chainlink Contracts | ^1.1.0 | 价格数据获取 |
| 开发工具 | ethers.js | ^6.8.0 | Ethereum 交互库 |
| 部署工具 | hardhat-deploy | ^0.11.38 | 简化合约部署流程 |
| 测试框架 | Mocha | ^10.2.0 | 合约测试 |
| 断言库 | Chai | ^4.3.10 | 测试断言 |

## 3. 架构设计

### 3.1 合约架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端应用层                              │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         区块链网络                              │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      NFT 拍卖市场合约                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │                 │  │                 │  │                 │  │
│  │   NFT 合约      │  │   拍卖合约      │  │   预言机集成    │  │
│  │  (ERC721 + UUPS)│  │  (UUPS 代理)    │  │  (Chainlink)    │  │
│  │                 │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      外部依赖服务                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │                 │  │                 │  │                 │  │
│  │ Chainlink 预言机│  │   ERC20 代币    │  │ Ethereum 网络   │  │
│  │  (价格数据)     │  │  (支付方式)     │  │  (ETH 支付)     │  │
│  │                 │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心功能模块

#### 3.2.1 NFT 模块
- 实现 ERC721 标准
- 支持 NFT 铸造
- 支持 NFT 转移
- 支持 UUPS 代理升级

#### 3.2.2 拍卖模块
- 拍卖创建
- 多币种出价
- 拍卖结束处理
- 资金与 NFT 结算

#### 3.2.3 价格预言机模块
- Chainlink FeedData 集成
- ETH/USD 价格获取
- ERC20/USD 价格获取
- 价格转换与比较

#### 3.2.4 升级模块
- UUPS 代理模式实现
- 合约逻辑升级
- 状态数据保留

### 3.3 数据流

1. **拍卖创建流程**
   - 用户调用 `createAuction` 方法，传入 NFT 信息和拍卖参数
   - 合约验证 NFT 所有权并转移至合约托管
   - 初始化拍卖状态，设置开始时间和结束时间

2. **出价流程**
   - 用户调用 `placeBid` 方法，传入拍卖 ID 和出价金额
   - 合约获取当前价格数据（通过 Chainlink 预言机）
   - 将出价金额转换为 USD 进行比较
   - 验证出价是否高于当前最高出价
   - 更新最高出价和出价者信息

3. **拍卖结束流程**
   - 任何人可调用 `endAuction` 方法（拍卖结束后）
   - 合约验证拍卖是否已结束
   - 将 NFT 转移给最高出价者
   - 将资金转移给卖家
   - 重置拍卖状态

## 4. 合约设计

### 4.1 NFT 合约（AuctionNFT.sol）

#### 4.1.1 核心功能
- ERC721 标准实现
- 可升级（UUPS 代理模式）
- 支持铸造、转移、查询

#### 4.1.2 关键函数
- `mint(address to, string memory uri) public` - 铸造新 NFT
- `tokenURI(uint256 tokenId) public view returns (string memory)` - 获取 NFT URI
- `_authorizeUpgrade(address newImplementation) internal` - 授权合约升级

### 4.2 拍卖合约（NFTMarketplace.sol）

#### 4.2.1 核心数据结构

```solidity
struct Auction {
    uint256 id;
    address seller;
    address nftContract;
    uint256 tokenId;
    uint256 startTime;
    uint256 endTime;
    uint256 reservePrice;
    address highestBidder;
    uint256 highestBid;
    address paymentToken;
    bool ended;
}
```

#### 4.2.2 关键函数
- `createAuction(address nftContract, uint256 tokenId, uint256 reservePrice, uint256 duration, address paymentToken) public` - 创建拍卖
- `placeBid(uint256 auctionId) public payable` - 出价（支持 ETH 和 ERC20）
- `endAuction(uint256 auctionId) public` - 结束拍卖并结算
- `withdraw() public` - 提取资金

### 4.3 预言机集成

#### 4.3.1 核心功能
- 集成 Chainlink Price Feeds
- 支持 ETH/USD 和 ERC20/USD 价格获取
- 价格转换与比较

#### 4.3.2 关键函数
- `getLatestPrice(address aggregator) internal view returns (int)` - 获取最新价格
- `convertToUSD(uint256 amount, address token) public view returns (uint256)` - 转换为 USD
- `compareBids(uint256 bid1, address token1, uint256 bid2, address token2) internal view returns (bool)` - 比较不同代币的出价

### 4.4 升级机制

采用 UUPS（Universal Upgradeable Proxy Standard）代理模式，主要包括：

- 代理合约（Proxy）：存储合约状态，转发调用
- 实现合约（Implementation）：包含合约逻辑
- 升级接口（UUPSUpgradeable）：允许合约升级

## 5. 项目结构

```
├── contracts/                 # 智能合约
│   ├── AuctionNFT.sol        # NFT 合约
│   ├── NFTMarketplace.sol    # 拍卖合约
│   └── interfaces/           # 接口定义
├── deploy/                   # 部署脚本
│   ├── 01_deploy_nft.js      # NFT 合约部署
│   └── 02_deploy_marketplace.js  # 拍卖合约部署
├── test/                     # 测试文件
│   ├── AuctionNFT.test.js    # NFT 合约测试
│   └── NFTMarketplace.test.js  # 拍卖合约测试
├── scripts/                  # 辅助脚本
│   ├── mint-nft.js           # NFT 铸造脚本
│   └── create-auction.js     # 拍卖创建脚本
├── hardhat.config.js         # Hardhat 配置
├── package.json              # 项目依赖
└── README.md                 # 项目说明
```

## 6. 部署流程

### 6.1 本地测试网络部署

1. 启动 Hardhat 本地网络：
   ```bash
   npx hardhat node
   ```

2. 部署合约：
   ```bash
   npx hardhat deploy --network localhost
   ```

### 6.2 Sepolia 测试网部署

1. 配置 Sepolia 网络参数（在 hardhat.config.js 中）
2. 部署合约：
   ```bash
   npx hardhat deploy --network sepolia
   ```

### 6.3 部署顺序

1. 部署 NFT 合约（AuctionNFT）
2. 部署拍卖合约（NFTMarketplace）
3. 验证合约（可选）：
   ```bash
   npx hardhat verify --network sepolia <CONTRACT_ADDRESS> <CONSTRUCTOR_ARGS>
   ```

## 7. 测试计划

### 7.1 单元测试

| 测试模块 | 测试用例 |
|----------|----------|
| NFT 合约 | 铸造功能测试 |
| NFT 合约 | 转移功能测试 |
| NFT 合约 | 元数据查询测试 |
| 拍卖合约 | 拍卖创建测试 |
| 拍卖合约 | ETH 出价测试 |
| 拍卖合约 | ERC20 出价测试 |
| 拍卖合约 | 拍卖结束测试 |
| 预言机集成 | 价格获取测试 |
| 预言机集成 | 价格转换测试 |

### 7.2 集成测试

| 测试场景 | 测试内容 |
|----------|----------|
| 完整拍卖流程 | 创建拍卖 → 多次出价 → 结束拍卖 → 结算 |
| 多币种出价比较 | 不同代币出价的 USD 转换与比较 |
| 合约升级 | 升级合约逻辑，验证状态保留 |

### 7.3 测试命令

```bash
# 运行所有测试
npx hardhat test

# 运行特定测试文件
npx hardhat test test/NFTMarketplace.test.js

# 生成测试覆盖率报告
npx hardhat coverage
```

## 8. 安全考虑

### 8.1 合约安全
- 使用 OpenZeppelin 经过审计的合约库
- 实现重入攻击防护
- 适当的访问控制
- 输入验证与边界检查

### 8.2 预言机安全
- 使用 Chainlink 可信预言机
- 实现价格更新频率限制
- 处理预言机故障情况

### 8.3 升级安全
- 仅允许授权地址升级合约
- 升级前进行充分测试
- 考虑使用时间锁机制

## 9. 后续扩展

### 9.1 可选功能
- 动态手续费（根据拍卖金额调整）
- 拍卖撤销功能
- 批量拍卖创建
- 拍卖历史记录查询
- 前端界面开发

### 9.2 性能优化
- 实现高效的拍卖查询
- 优化 Gas 费用
- 考虑使用 Layer 2 解决方案

## 10. 文档与交付物

### 10.1 技术文档
- 架构设计文档（本文件）
- 合约 API 文档
- 部署指南

### 10.2 代码交付物
- 完整的智能合约代码
- 测试脚本
- 部署脚本
- 配置文件

### 10.3 测试报告
- 单元测试结果
- 集成测试结果
- 测试覆盖率报告

## 11. 开发时间线

| 阶段 | 时间 | 任务 |
|------|------|------|
| 项目初始化 | 1 天 | 环境搭建、依赖安装 |
| NFT 合约开发 | 1 天 | 实现 ERC721 合约、测试 |
| 拍卖合约开发 | 2 天 | 实现拍卖逻辑、测试 |
| 预言机集成 | 1 天 | Chainlink 集成、测试 |
| 合约升级实现 | 1 天 | UUPS 代理模式实现、测试 |
| 部署与验证 | 1 天 | 部署到 Sepolia 测试网 |
| 文档编写 | 1 天 | 整理架构设计、API 文档 |
| 总计 | 8 天 | |

---

## 附录：配置文件示例

### hardhat.config.js

```javascript
require('@nomiclabs/hardhat-ethers');
require('hardhat-deploy');
require('dotenv').config();

module.exports = {
  solidity: {
    version: '0.8.19',
    settings: {
      optimizer: {
        enabled: true,
        runs: 200,
      },
    },
  },
  networks: {
    localhost: {
      url: 'http://127.0.0.1:8545',
    },
    sepolia: {
      url: process.env.SEPOLIA_URL,
      accounts: [process.env.PRIVATE_KEY],
    },
  },
  namedAccounts: {
    deployer: {
      default: 0,
    },
  },
};
```

### .env 示例

```
SEPOLIA_URL=https://sepolia.infura.io/v3/YOUR_INFURA_KEY
PRIVATE_KEY=YOUR_PRIVATE_KEY
ETHERSCAN_API_KEY=YOUR_ETHERSCAN_KEY
```